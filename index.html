<!doctype html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Shain&#39;s Blogs">
<meta property="og:url" content="https://shain001.github.io/index.html">
<meta property="og:site_name" content="Shain&#39;s Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Shain">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://shain001.github.io/"/>





  <title> Shain's Blogs </title>
<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shain's Blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/12/17/test-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/12/17/test-1/" itemprop="url">
                  test
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-12-17T01:08:08+11:00">
                2022-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Ssss</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/02/19/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E4%BD%8D%E8%BF%90%E7%AE%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/02/19/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E4%BD%8D%E8%BF%90%E7%AE%97/" itemprop="url">
                  算法随手-位运算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-02-19T17:15:12+11:00">
                2022-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Overall"><a href="#Overall" class="headerlink" title="Overall"></a>Overall</h1><p>位运算， 无非： 与， 或， 非， 左移， 右移， 异或。 </p>
<p>目前接触到位运算的思路主要两种：</p>
<ul>
<li>利用异或，找出重复元素：<ul>
<li>leetcode 136. 只出现一次的数字</li>
</ul>
</li>
<li>利用 左移+与或， 达到用 bit 形成 bool数组， 也即 Redis中的bitmap的形式：<ul>
<li>leetcode 面试题 01.01 判断无重复字符的字符串</li>
</ul>
</li>
<li>信息论 （略）：<ul>
<li>老鼠试毒</li>
</ul>
</li>
</ul>
<p>关于异或， 其记忆的点为： 异或结果与顺序无关。</p>
<p>关于 左移+与或  这种类型， 只需记忆 bitmap即可， 当一个问题， 需要使用 数组记录一 二元变量的值时， 可以考虑使用 bitmap 替代 Bool[]。</p>
<p>而bitmap的使用关键， 即是理解， 要 update bitmap中的一位， 则需 将 bitmap 与一 tempBit 进行 或 运算。 读， 则进行 与 运算。 其中 tempBit是一个只包含一个 ‘1’ 的二进制数字。 1 所在的 索引， 即要 读/写 的 bitmap中的对应位索引。</p>
<p>同时， 字符转数字， 则可通过ASC码实现。 一个字符， 直接进行 左移/右移， 输出的就是数字。 如果需要标的， 则可通过 ”字符-a“ 实现锚定。</p>
<h2 id="Sample-Question"><a href="#Sample-Question" class="headerlink" title="Sample Question"></a>Sample Question</h2><h4 id="leetcode-136"><a href="#leetcode-136" class="headerlink" title="leetcode 136"></a>leetcode 136</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Given a non-empty array of integers nums, every element appears twice except for one. Find that single one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You must implement a solution with a linear runtime complexity and use only constant extra space.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">输入一组数字， 每个元素都重复一次， 只有 一个元素是单独出现的， 没有重复， 找出这个单独的元素</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">使用异或：</span></span><br><span class="line"><span class="string">异或的特点： 相同为0， 不同为1， “并且异或的顺序不影响结果” 即 A ^ B ^ A ^ B ^ C = A ^ A ^ B ^ B ^ C..</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>(<span class="params">nums</span>):</span></span><br><span class="line">    to_return = <span class="number">0</span> <span class="comment"># 之所以初始化为0， 因为 如果 0 与 01010110 异或的话， 原值不变, e.g. 0 ^ 34 = 34</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(nums)):</span><br><span class="line">        to_return = to_return ^ nums[i]</span><br><span class="line">    <span class="keyword">return</span> to_return</span><br></pre></td></tr></table></figure>



<h4 id="leetcode-面试题01-01"><a href="#leetcode-面试题01-01" class="headerlink" title="leetcode 面试题01.01"></a>leetcode 面试题01.01</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无重复字符的字符串</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 利用bit运算解决 --&gt; 即， 利用 Redis中的bitmap的思路， 形成一个二进制数， 而这个二进制数即相当于一个bool数组。</span></span><br><span class="line"><span class="comment"> * 为什么是bool数组？ 因为 每一位上不是0就是1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 那么接下来， 即如何实现的问题：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. 将字符转换为数字 --&gt; ASC码。</span></span><br><span class="line"><span class="comment"> * 2. 如何将 转换后的数字， 映射到 二进制数字中的一位？ 即， 转换后的数字相当于一个索引， 如何利用这个索引， 读/写 二进制中的某一位？</span></span><br><span class="line"><span class="comment"> *    即， 如何将 1001 改为 1000？ 同时， 如何读取到 1001中的 第2 位是0还是1？</span></span><br><span class="line"><span class="comment"> *    --&gt;</span></span><br><span class="line"><span class="comment"> *    通过 与， 或运算。 与即是 读， 或等 便是 写。</span></span><br><span class="line"><span class="comment"> *    以 1001 为例， 要判断 1001 的低处第2位是不是1， 则可用 0010 跟 1001 做 and， 则结果为 1 则代表 第二位为1， 反之为0.</span></span><br><span class="line"><span class="comment"> *    那么， 要将 1001 的低处低2位改为1， 则， 使 1001 |= 0010 即可。 因为 0|0 为0， 0|1 为1， 用0做或， 不会改变原值. 而1 或 任何数</span></span><br><span class="line"><span class="comment"> *    均为1， 所以能达到更改某一个位的值的作用。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 3. 至此， 仅剩最后一个步骤， 即如何将字符转换为一个二进制数？</span></span><br><span class="line"><span class="comment"> * --&gt; 左移 + ASC码。</span></span><br><span class="line"><span class="comment"> *     3.1 首先， 要的到 1000， 则只需 将 0001， 也即1， 左移3 位即可。</span></span><br><span class="line"><span class="comment"> *     3.2 每个字符， 与 ‘a’ 相减， 则能得到一个唯一数 x， 也即， 1 左移 x位， 就能得到该字符对应的唯一 二进制数。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 4. 最后， 针对此题的context， 字符的数量， 也即字符的种类， 最多有128个， 也即需要 128 位 这么长的二进制数， 也即， 两个 long型变量。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UniqueLCCI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println(checkUnique(&quot;123&quot;));</span></span><br><span class="line">        <span class="keyword">char</span> c = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">        System.out.println(c&lt;&lt;<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkUnique</span><span class="params">(String target)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// high 64 bits and low 64bits</span></span><br><span class="line">        <span class="keyword">long</span> high = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> low = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Character c : target.toCharArray())&#123;</span><br><span class="line">            <span class="comment">// check use high bits or low bits</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="number">64</span>)&#123;</span><br><span class="line">                <span class="keyword">long</span> toBit = <span class="number">1l</span> &lt;&lt; (c-<span class="number">64</span>);</span><br><span class="line">                <span class="keyword">if</span> ((high &amp; toBit) != <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// if not return, then update high bits to record a character</span></span><br><span class="line">                high |= toBit;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">long</span> toBit = <span class="number">1l</span> &lt;&lt; c;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((low &amp; toBit) != <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                low |= toBit;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/01/23/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/01/23/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" itemprop="url">
                  算法随手-动态规划
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-01-23T19:11:03+11:00">
                2022-01-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="动态规划标志："><a href="#动态规划标志：" class="headerlink" title="动态规划标志："></a>动态规划标志：</h1><ul>
<li>求最优解， 但是又不要求具体路径。</li>
</ul>
<h2 id="二维dp的优化"><a href="#二维dp的优化" class="headerlink" title="二维dp的优化"></a>二维dp的优化</h2><p>核心： 滚动数组</p>
<p>直接看例子即可， 不好语言表述：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_path</span>(<span class="params">grid</span>):</span></span><br><span class="line">    dp = [[<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid[<span class="number">0</span>]))] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(grid))]</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = grid[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">        dp[<span class="number">0</span>][i] = dp[<span class="number">0</span>][i - <span class="number">1</span>] + grid[<span class="number">0</span>][i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid)):</span><br><span class="line">        dp[j][<span class="number">0</span>] = dp[j - <span class="number">1</span>][<span class="number">0</span>] + grid[j][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(grid[<span class="number">0</span>])):</span><br><span class="line">            dp[i][j] = grid[i][j] + <span class="built_in">max</span>(dp[i-<span class="number">1</span>][j], dp[i][j-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[-<span class="number">1</span>][-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_path_loop</span>(<span class="params">grid: <span class="type">List</span>[<span class="type">List</span>]</span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Point is that, when optimize space complexity for 2d dp array, we can only optimize 2d to 1d array.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    注意观察 3 Mention commented in the code</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    优化原理：</span></span><br><span class="line"><span class="string">    一句话概括：  dp变成了滚动数组。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    首先， 对于二维dp中每一个格子i, j的计算， 我们需要的只有三个数： 1. up， 2. left， 3. grid中的i,j 的值</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    那么， 只要优化后的一维数组 能够记录到 1 &amp; 2 ， 则可计算 出 i， j的值。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    只用一维数组怎么表示i，j的值？</span></span><br><span class="line"><span class="string">    第一层循环的for row in rows， 就相当于表示了i， 而j， 则是第二层循环的col表示。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    怎么用一维dp记录的 上下两个维度的数？</span></span><br><span class="line"><span class="string">    滚动数组， 当遍历到dp_oned[col]时， 当前的dp_oned[col] 的值， 还是记录着 dp[i-1][j]的值， 但是dp_oned[col-1]已经被更新成了dp[i][j-1]了。</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    那二维dp中的第一行怎么办？ </span></span><br><span class="line"><span class="string">    初始 dp_oned 为 grid[0]</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    那最上面一行， 最左侧一列的数怎么办？ 这一行/一列的数据， 没有上面/左侧的格子。 </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    看Mention 2</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    具体讲：</span></span><br><span class="line"><span class="string">    首先， 优化后的一维 dp， 相当于先记录了 原2维dp的第一行所有数，然后变成 第二行， ....</span></span><br><span class="line"><span class="string">    其次， 对于优化后的一维dp， 其每一个元素都对应着原dp中的一个i, j， 再dp[j]被更新之前， 它还保存着 原dp[i-1, j]的值。 同时， 由于是从左到右不停的	   遍历dp。</span></span><br><span class="line"><span class="string">    这意味着 当 遍历到 dp[j]的时候， dp[j] 左边的格子 dp[j-1] 已经被更新， 即意味着其记录的值， 已经是原二维dp中的 i-1,j 这个格子的值了。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    说话不好理解， 看例子：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    懒的画。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    只要记住， 对于每一次循环过程中， 再 col 变成 len(cols) - 1之前， 一维的dp中 既有 二维dp中 第i 行的值， 也有第 i-1 行的值。</span></span><br><span class="line"><span class="string">    而当一次 cols for结束， row从i 变为 i-1时， dp表示的行， 就从二维dp中的第i行变为第i+1行。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param grid:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cols = <span class="built_in">len</span>(grid[<span class="number">0</span>])</span><br><span class="line">    rows = <span class="built_in">len</span>(grid)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mention 1</span></span><br><span class="line">    dp = grid[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Mention 2</span></span><br><span class="line">            left_max = <span class="number">0</span> <span class="keyword">if</span> col == <span class="number">0</span> <span class="keyword">else</span> dp[col-<span class="number">1</span>]</span><br><span class="line">            up_max = <span class="number">0</span> <span class="keyword">if</span> row == <span class="number">0</span> <span class="keyword">else</span> dp[col]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Mention 3</span></span><br><span class="line">            dp[col] = grid[row][col] + <span class="built_in">max</span>(left_max, up_max)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dp[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>



<p>Original by Shain at Mel, Australia</p>
<p>Last Updated: 2022/1/23</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/01/20/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E6%95%B0%E7%BB%84-%E5%AD%97%E7%AC%A6%E4%B8%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/01/20/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E6%95%B0%E7%BB%84-%E5%AD%97%E7%AC%A6%E4%B8%B2/" itemprop="url">
                  算法随手-数组/字符串
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-01-20T21:41:33+11:00">
                2022-01-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数组问题的时间复杂度优化"><a href="#数组问题的时间复杂度优化" class="headerlink" title="数组问题的时间复杂度优化"></a>数组问题的时间复杂度优化</h1><h2 id="overalll"><a href="#overalll" class="headerlink" title="overalll"></a>overalll</h2><p>单纯的与数组相关的问题（包括字符串）， 题目本身通常不难， 难点在与如何优化时间复杂度。</p>
<p>例如：</p>
<ul>
<li>offer 39-41 ：<ul>
<li>找到数组中数量大于一半的数字</li>
<li>找到数组中第k小的k个数</li>
<li>找到流数据的中位数</li>
</ul>
</li>
</ul>
<p>这些问题， 使用单纯的暴力排序均可解答， 但时间复杂度较高。</p>
<p>可以使用的优化方法：</p>
<ul>
<li><p>Partition：</p>
<ul>
<li><p>如果问题问的是 第k个数怎么怎么样， 例如数组中第k大的数，或者最小的k个数， 那么可以使用Partition求解。</p>
<p>因为通过快排的partition方法， 可以O(n) 的找到第k小的数字， 当然这也包扩小于第k小数字的所有数字。</p>
</li>
</ul>
</li>
<li><p>二分：</p>
<ul>
<li>如果是找 两个数组中第k小的数字， 那么除了merge两个数组以外， 可以使用二分的思想， 当然使用二分的前提是两个数组均是排序的。</li>
</ul>
</li>
<li><p>数据结构的利用：</p>
<ul>
<li>priority queue： 最小堆， 最大堆</li>
<li>AVL Tree</li>
<li>链表</li>
</ul>
<p>offer41以及offer40.</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/01/18/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E5%9B%9E%E6%BA%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/01/18/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E5%9B%9E%E6%BA%AF/" itemprop="url">
                  算法随手-链表
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-01-18T15:20:25+11:00">
                2022-01-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="回溯问题总结："><a href="#回溯问题总结：" class="headerlink" title="回溯问题总结："></a>回溯问题总结：</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>无非三种情况：</p>
<ul>
<li><p>同一层级中， 每个节点的分支数相同。 –&gt; 使用 used[] 改变状态，不使用 start作为 递归方程的参数。 </p>
<ul>
<li>e.g.  leetcode 全排列1，2</li>
</ul>
</li>
<li><p>同一层级中， 每个节点的分支数不相同， 即同一层级中， 节点2 的分支中不包含节点1的元素， 同理， 节点三的分支中不包含节点1，2两个节点的元素。 –&gt; 使用 start 作为 递归方程的参数， 进而改变for循环开始位置， 即从start开始， 即：</p>
<ul>
<li>e.g. leetcode 39</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start):</span><br><span class="line">  back_track(start=i, xxx)</span><br></pre></td></tr></table></figure>

<ul>
<li>各层单个节点下分支数量相同， 但是在单个层中， 每个节点的元素数量在变化， 并且 输入元素的顺序不改变。 语言不好理解， 我想表达的是 Leetcode 93. IP地址， 以及offer46 的这种类型； （offer46 应用DP求解， 但bt也可以做， 只不过效率低）<ul>
<li>对于这种类型， 格式也较为固定，代码框架如下。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ip_config</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">back_track</span>(<span class="params">remained_s, ip, ip_seg, count</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 剪枝条件</span></span><br><span class="line">        <span class="keyword">if</span> .....</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 终止条件</span></span><br><span class="line">        <span class="keyword">if</span> count == <span class="number">1</span>:</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># ！！！！重点在这个for循环， 此处， i的范围， 表示 ”单个节点内， 元素数量的可能性“</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>):</span><br><span class="line">            ip_seg = remained_s[<span class="number">0</span>:i] + <span class="string">&quot;.&quot;</span></span><br><span class="line">            temp = ip + ip_seg</span><br><span class="line">            back_track(remained_s[i:], temp, ip_seg, count - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">4</span> <span class="keyword">or</span> <span class="built_in">len</span>(s) &gt; <span class="number">12</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    to_return = []</span><br><span class="line">    back_track(s, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">return</span> to_return</span><br></pre></td></tr></table></figure>



<p>通常， abc 不等同于 acb时， 则需使用情况1， 即使用used， 使分支数相同。 而若 abc 等同于 acb， 即顺序无关， 则应使用 情况2， 避免重复解。 </p>
<p>之所以情况二可以避免重复解，画个树， 或者举个例子即可明白。 简单说， e.g. 2为最上层节点， 其一条分支为 2， 2， 3； 那么到了最上层的2的同级节点3以后， 就不应该再在3的分支中包括2， 因为这样一定会出现一条分路 3， 2， 2，进而造成重复。</p>
<p>More About used：</p>
<p>Used 的作用即为： 控制单个节点下的分支个数，也即单个节点下的分支有哪些节点。 比如， 一个节点的分支中， 应不应该有自己？ 此时则应用used控制， 通过 递归前， 后的更改/还原状态控制。 </p>
<p>注意， used和start并非不可同时使用， 看情况判断。</p>
<h2 id="关于求子集问题"><a href="#关于求子集问题" class="headerlink" title="关于求子集问题"></a>关于求子集问题</h2><p>即 offer38 的扩展题。  输入123， 输出： 1， 2， 3， 12， 13， 23， 123</p>
<p><strong>即不仅仅输出“一条到叶子节点的路线”， 也要输出第一层， 第一层+第二层， 第一层+ 第二层+ … + 第n层</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">subset</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">back_track</span>(<span class="params">start, path</span>):</span></span><br><span class="line">      	<span class="comment"># 载递归函数入口就将path加到result上即可。</span></span><br><span class="line">        to_return.append(path[:])</span><br><span class="line">        <span class="keyword">if</span> start == <span class="built_in">len</span>(s) - <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, <span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span> used[i] <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">                used[i] = <span class="literal">True</span></span><br><span class="line">                back_track(i, path + [s[i]])</span><br><span class="line">                used[i] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    used = [<span class="literal">False</span>] * <span class="built_in">len</span>(s)</span><br><span class="line">    to_return = []</span><br><span class="line">    back_track(<span class="number">0</span>, [])</span><br><span class="line">    <span class="keyword">return</span> to_return</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>该问题相当于 上文中情况1， 2的结合使用。 即所说的used和start的同时使用的情况的例子。</p>
<p>唯一需要注意的是： 这一问题的特殊点在于不仅仅输出 到 叶子节点的完整路线， 也要输出“从第一层节点， 到每一个节点的temp 路线”。 实现原理很简单， 在函数入口 直接 append就可以。 </p>
<p>之所以这么实现， 是因为每调用一次 backtrack() , 就是向下创建了一层， 到达了一个新的子节点。 而此时， path中已经更新了当前这个新的叶子节点的值， 那么只需要直接append path to result， 就相当于实现了 “第一层节点， 到每一个节点的temp 路线都被记录下来”这一目的。</p>
<p> 如下图， 每call一次 backtrack， 就创建了一个新的子节点， 也即一条edge。 也即， 要记录从第一层节点到每一层节点的路径， 只需要在backtrack路口处添加path到result就可以。</p>
<p><img src="C:\Users\Senry\Desktop\bt.png" alt="bt"></p>
<h2 id="复杂些的问题-搜索问题？"><a href="#复杂些的问题-搜索问题？" class="headerlink" title="复杂些的问题 - 搜索问题？"></a>复杂些的问题 - 搜索问题？</h2><p>大概率从剪枝条件入手创造难度。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/01/07/Spring-Cloud-configures-Hystrix-using-Feign-Record/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/01/07/Spring-Cloud-configures-Hystrix-using-Feign-Record/" itemprop="url">
                  Spring Cloud configures Hystrix using Feign Record
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-01-07T16:15:36+11:00">
                2022-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="fallback-vs-fallbackFactory"><a href="#fallback-vs-fallbackFactory" class="headerlink" title="fallback vs fallbackFactory"></a>fallback vs fallbackFactory</h2><p>fallback 方式无法获取异常内容， 只能做降级。</p>
<p>fallbackFactory 可以获取异常内容。</p>
<h1 id="fallbackFactory-使用方式"><a href="#fallbackFactory-使用方式" class="headerlink" title="fallbackFactory 使用方式"></a>fallbackFactory 使用方式</h1><ol>
<li>Maven -&gt; Hystrix</li>
<li>配置文件修改</li>
<li>启动类注解@EnableCircuitBreaker开启断路器</li>
<li>Feign 接口 （接口名假设为Feign， 方便下文描述） 的注解 @FeignClient(……    fallbackFactory = FallBackClass.class)设置fallback =</li>
<li>创建FallBackClass-&gt; implements FallbackFactory<T> 接口， T值为Feign 接口类名</li>
<li>创建 InheritanceClass 接口， 继承 Feign接口 Feign。 内容为空即可。 </li>
<li> 在 FallBackClass中override FallbackFactory的方法， 只有一个 create 方法， 其返回值类型为 Feign， this is why we need to do step5。 </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PaymentConsumerFeign <span class="title">create</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// &#123;&#125;中的内容会被替换为 throwable.getMessage() 获取的内容</span></span><br><span class="line">    LOG.error(<span class="string">&quot;ExceptionTest = &#123;&#125;&quot;</span>, throwable.getMessage());</span><br><span class="line">    <span class="comment">// 之所以创建空接口 InheritanceClass， 因为此处直接return new ...即可</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PaymentConsumerWithFallBackFactory() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">consumePayment</span><span class="params">(String userId, String saleId)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Oops, server is busy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>LOG.error(“ExceptionTest = {}”, throwable.getMessage())输出的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExceptionTest = status 500 reading PaymentConsumerFeign#consumePayment(String,String); content:</span><br><span class="line">&#123;&quot;timestamp&quot;:&quot;2022-01-07T06:41:58.885+0000&quot;,&quot;status&quot;:500,&quot;error&quot;:&quot;Internal Server Error&quot;,&quot;message&quot;:&quot;Not Created Yet&quot;,&quot;path&quot;:&quot;/processPayment&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>Provider中抛出的异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (state == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Not Created Yet&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="fallback方式的使用"><a href="#fallback方式的使用" class="headerlink" title="fallback方式的使用"></a>fallback方式的使用</h2><p>只需：</p>
<ol>
<li> @FeignClinet()中设置为fallback = FallBackClass</li>
<li>创建FallBackClass， implements Feign接口</li>
<li>对于每个方法， 写出降级内容即可</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2022/01/03/project-reflection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2022/01/03/project-reflection/" itemprop="url">
                  project reflection
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-01-03T16:20:27+11:00">
                2022-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Zookeeper伪集群搭建"><a href="#Zookeeper伪集群搭建" class="headerlink" title="Zookeeper伪集群搭建"></a>Zookeeper伪集群搭建</h1><ol>
<li><p>下载zookeeper</p>
</li>
<li><p>解压修改config中的dataDir and dataLogDir</p>
</li>
<li><p>复制三份加压安装好后的文件， 方便运行不同server。（若不复制， 则直接创建三份不同的config文件， 运行时指明conf文件）。</p>
</li>
<li><p>分别修改三个复制后zookeeper中的config， 修改各自的clientport + dataDir + logDir + server.1 = .. server.2 = …</p>
</li>
<li><p>在data文件夹中创建myid， 内容为1，2， 3， … 目的为指明各个server的id</p>
</li>
<li><p>分别运行即可</p>
</li>
</ol>
<h1 id="SpringBoot整合zookeeper为注册中心-（跟Eureka一个作用）"><a href="#SpringBoot整合zookeeper为注册中心-（跟Eureka一个作用）" class="headerlink" title="SpringBoot整合zookeeper为注册中心 （跟Eureka一个作用）"></a>SpringBoot整合zookeeper为注册中心 （跟Eureka一个作用）</h1><p>Reflection:</p>
<ol>
<li>Eureka vs Zookeeper</li>
</ol>
<p>实现：</p>
<ol>
<li><p>zookeeper注册中心配置必须在boostrap.yml,  why application.yml不生效？</p>
</li>
<li><p>在application.yml中配置service信息</p>
</li>
</ol>
<h1 id="关于支付模块修改订单状态的问题"><a href="#关于支付模块修改订单状态的问题" class="headerlink" title="关于支付模块修改订单状态的问题"></a>关于支付模块修改订单状态的问题</h1><h4 id="Confusion"><a href="#Confusion" class="headerlink" title="Confusion:"></a>Confusion:</h4><p>首先， 该confusion以 用户跳转支付页面与orderGeneration模块 parallel为前提。</p>
<p>创建订单的模块从MQ接受消息， 然后创建订单， 这个创建订单的处理速度受MQ限制。</p>
<p>那么会不会有一种情况， 当1000个用户一瞬间抢完商品， 之后1000个用户同时点击“支付完成”， 点击该button会ping到修改订单状态的API。 即， 这1000 个订单可能在 抢购结束后， 立刻， 且同时， 被要求更改订单状态。 但是， 此时1000个订单可能还没有都被创建到数据库。 那么有的用户在点击”支付完成“时可能会返回报错， 即修改订单失败，因为后端无法修改到订单状态（该raw还未被创建）。</p>
<h4 id="solution"><a href="#solution" class="headerlink" title="solution:"></a>solution:</h4><ol>
<li> 假设该问题无法解决， 则修改订单失败时返回降级页面， 提示用户等下再支付。 若如此解决， project需添加购物车， 进而有需要分布式Session</li>
</ol>
<h4 id="关于Confusion中的状况实际上应该不会发生的猜想："><a href="#关于Confusion中的状况实际上应该不会发生的猜想：" class="headerlink" title="关于Confusion中的状况实际上应该不会发生的猜想："></a>关于Confusion中的状况实际上应该不会发生的猜想：</h4><p>实际业务中， 由于有支付环节， 该环节中需要：</p>
<p>​    a) 检测安全环境</p>
<p>​    b) ping支付宝/微信/paypal… 的API</p>
<p>​    c) 输入密码</p>
<p>​    d) 支付API处理请求</p>
<p>这些过程耗时至少10s - 20s。 </p>
<p>在实际业务中， 用户抢购商品以后 -&gt; 后端开始创建订单, 同时， 另一个支付Model 被parallel的运行， 引导用户付款。 -&gt;付款结束才能点击支付完成， 或者支付完成，在payment model中修改订单状态。 </p>
<p>由于支付业务耗时长， 所以订单应该一定已经被创建。 </p>
<p><strong>同时， 为了加快订单创建速度， 保证修改某订单状态时， 订单状态一定要保证完成， 可以增加 order Model的数量， 同时rabbitMQ中多建几个queue， 多个ordermodel 分发处理以加快订单创建速度。</strong></p>
<h4 id="关于能否通过先在Redis缓存订单来解决该问题："><a href="#关于能否通过先在Redis缓存订单来解决该问题：" class="headerlink" title="关于能否通过先在Redis缓存订单来解决该问题："></a>关于能否通过先在Redis缓存订单来解决该问题：</h4><p>应该不现实， 因为订单数量极大的情况下， redis内存抗不住， 只能增加redis服务器数量， 不值得。因为在秒杀情况下， users大概率可以接受服务降级， 或服务速度减慢。 </p>
<h3 id="实际上的架构"><a href="#实际上的架构" class="headerlink" title="实际上的架构"></a>实际上的架构</h3><p><img src="E:\BBlog\source_data\images\payment_orderGeneration.png" alt="payment_orderGeneration"></p>
<h1 id="记录一次RabbitMQ-重复消费-“cannot-ack-nack”-产生的超卖"><a href="#记录一次RabbitMQ-重复消费-“cannot-ack-nack”-产生的超卖" class="headerlink" title="记录一次RabbitMQ 重复消费 “cannot ack/nack” 产生的超卖"></a>记录一次RabbitMQ 重复消费 “cannot ack/nack” 产生的超卖</h1><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>忘记在 RabbitQueue Consumer中， 即 order module 的 application.yml 中配置 RabbitMQ。 进而导致默认使用了自动ACK模式。</p>
<p>具体原因待研究。</p>
<h3 id="表象"><a href="#表象" class="headerlink" title="表象"></a>表象</h3><p>懒得截图：</p>
<p>100个库存， 压测并发100 个请求时， 查询MySQL发现下了199个订单一次， 201个订单一次， flash_sale表跟 order表数据是一致的， 即同时 减少/增加相同的订单量。 但是Redis中库存始终正确， 未出现超卖现象。</p>
<p>同时order model报错  cannot ack/nack。</p>
<h2 id="MyBatis-Update-…-引发的报错：-“There-is-no-getter-for-property-named-‘’-in-‘class-java-lang-String"><a href="#MyBatis-Update-…-引发的报错：-“There-is-no-getter-for-property-named-‘’-in-‘class-java-lang-String" class="headerlink" title="MyBatis @Update(…..  ${} )引发的报错： “There is no getter for property named ‘’ in ‘class java.lang.String"></a>MyBatis @Update(…..  ${} )引发的报错： “There is no getter for property named ‘’ in ‘class java.lang.String</h2><p>原因：</p>
<p>${}  and #{}的使用错误， 修改为 #{}后报错消失， 但是其他接口方法中（@Insert）使用 ${}没有报错， 正常运行。</p>
<p>待仔细学习MyBatis后解答。</p>
<h1 id="关于Order-Module中的疑问"><a href="#关于Order-Module中的疑问" class="headerlink" title="关于Order Module中的疑问"></a>关于Order Module中的疑问</h1><h4 id="Current-Version-of-Code"><a href="#Current-Version-of-Code" class="headerlink" title="Current Version of Code:"></a>Current Version of Code:</h4><ol>
<li>recievge message from MQ</li>
<li>write order to db</li>
<li>change stock in db</li>
<li>return ack to MQ to tell MQ delete the message</li>
</ol>
<p>整个Order Module没有任何返回值， 即状态返回。</p>
<h4 id="Confusion-1"><a href="#Confusion-1" class="headerlink" title="Confusion:"></a>Confusion:</h4><p>测试发现， 数据库操作即使失败， 依然会返回ack删除数据。如何解决?</p>
<p>同时， write正常工作时， 如果 change stock方法出错， 也是依然返回了ACK。</p>
<p>是因为加了try catch才没有在方法执行失败时 卡住程序？ 怎么解决？ 不能把ack返回写在finally中， 因为这样就是无论对错消息都删除了。</p>
<p>目前用的解决方案：</p>
<p>Service方法中返回值， 即更新数据库的方法的返回值 == 1时才return ACK。 有无更好方法？</p>
<p>并且实际业务中， Order模块没有任何返回状态的话， 如果出了问题如何发现？</p>
<h1 id="關於Bloom-Filter"><a href="#關於Bloom-Filter" class="headerlink" title="關於Bloom Filter"></a>關於Bloom Filter</h1><p>zuul中加了bloom filter 解決緩存擊穿問題及過濾非法請求。</p>
<p>在product scan scheduler中<strong>反復刷新</strong>bloom filter。</p>
<p>之所以要刷新， 而不是反復添加， 理由如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// rBloomFilter doesn&#x27;t have method to remove a elements, so if do not refresh, then with time increase</span><br><span class="line">// all bits in the bloom filter will be filled out, which means all retrieve will be returned true, the bloom</span><br><span class="line">// filter will lose its meanning.</span><br><span class="line">// so here every time scanning the flash sale DB, we refresh the bloom filter to maintain the precision.</span><br><span class="line">// Although this may cause a problem that during this task is refreshing the bloom filter,</span><br><span class="line">// there might be a short period that bloom filter lacks some elements, so some impossible requests may not be</span><br><span class="line">// filtered by the gateway, the number of such requests should not too much.</span><br><span class="line">// More importantly by now I don&#x27;t see other solutions.</span><br></pre></td></tr></table></figure>



<h1 id="待看"><a href="#待看" class="headerlink" title="待看"></a>待看</h1><ol>
<li><p>启动类中@FeignClients注解不加参数就找不到bean</p>
</li>
<li><p>细看 Hystrix, Ribbon, Feign</p>
</li>
<li><p>Netty</p>
</li>
<li><p>细看操作系统 -&gt; NIO， 虚拟内存</p>
</li>
<li><p>java异常 classes</p>
</li>
<li><p>SpringCloud Gateway VS Zuul</p>
</li>
<li><p>Zuul 配置timeout时间， 默认时间多少？ 不配置则得到了</p>
</li>
<li><p><strong>RabbitMQ unacked Message caused lots of message blocked:</strong></p>
<p>​    表象：</p>
<p>​        OrderGenerate Module中收不到新的订单消息。</p>
<p>​        RabbitMQ中始终显示一条unacked Message</p>
<p>​    原因：</p>
<pre><code>      1. 逻辑错误： 设定 if(updateState and changeState == 1) 才返回ACK， ”但是module刚启动时， 同时更新了多条消息？ **两个state值不为0**，导致没有返回ACK， 更新为 if (xxxx,xxxx != 0) 后不在有ACK “



 8. 2 ordermodel的application.yml中只配置了 web_order的分表， 由于 web_seckill未使用分表， 所以没有配置， 但是报错了 FlashSale_2.web_seckill不存在。
</code></pre>
<p>​    </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.zuul.exception.ZuulException: Forwarding error</span><br><span class="line">+</span><br><span class="line">readtimeout 报错；</span><br><span class="line">应该时默认超时时间过短导致</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Data-Sharding-and-RW-Splitting-Archetecture"><a href="#Data-Sharding-and-RW-Splitting-Archetecture" class="headerlink" title="Data Sharding and RW Splitting Archetecture"></a>Data Sharding and RW Splitting Archetecture</h1><p><img src="E:\ShianGit\flash_sale\images\MySQL-Archetecture\data_sarding_RWSplitting.jpg" alt="data_sarding_RWSplitting"></p>
<p>Web_seckill 未做分表/分库。 不知道是否规范， 未做原因在于判断 秒杀商品数量不多， 对于该表访问压力不大 ；</p>
<p>Specificly,  该项目逻辑为 —-  创建订单的同时扣减库存。 创建订单Module从MQ消费消息， 消费QPS均固定， 并且可控。 Moreover, 秒杀过程中对于库存的查询皆走的Redis， 进一步减小了对该表的访问频率。  MoreMoreover， 对该表的查询，只在product scanning 定时进行， 频率也可控， 且访问量不大， 且Master-Slave的读写分离顺带着给web_seckill库存表也做了读写分离， 又进一步减小数据库压力。   因此判断数据库压力不大， 故未做分表/分库。 </p>
<p>一句话概括上面内容：</p>
<p>web_seckill 的访问压力 可控， 并且不大， 所以不作。  不大的原因： 1.  访问QPS由 消费MQ的速度决定，所以”写“ 速度 可控。  2.  读写分离的设定， 又进一步减小了压力。 并且对于web_seckill表的读取， 每xx分钟才由 product scanning scheduler进行一次， 读取频率很低。</p>
<p>PS:</p>
<p>web_seckill秒杀库存表应该可以做成broadcast table， 未作。</p>
<p>Shardingj 配置 –  分库分表Only：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">shardingsphere:</span><br><span class="line">  # 1. Configure DataSource, same as normal datasource configuration</span><br><span class="line">  datasource:</span><br><span class="line">    # Allocate name to different databases</span><br><span class="line">    names: ds1,ds2</span><br><span class="line">    # Configure each databases</span><br><span class="line">    ds1:</span><br><span class="line">      # configure type first -&gt; can use almost any connection pool</span><br><span class="line">      type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">      driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">      # This has to be jdbc-url instead of url, otherwise the system cannot find the url address</span><br><span class="line">      jdbc-url: jdbc:p6spy:mysql://192.168.100.128:3306/FlashSale</span><br><span class="line">      username: root</span><br><span class="line">      password: 1122110</span><br><span class="line">      hikari:</span><br><span class="line">        maximum-pool-size: 30</span><br><span class="line">        minimum-idle: 10</span><br><span class="line">    ds2:</span><br><span class="line">      # configure type first -&gt; can use almost any connection pool</span><br><span class="line">      type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">      driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">      jdbc-url: jdbc:p6spy:mysql://192.168.100.128:3306/FlashSale_2?serverTimezone=GMT%2B10</span><br><span class="line">      username: root</span><br><span class="line">      password: 1122110</span><br><span class="line">      hikari:</span><br><span class="line">        maximum-pool-size: 30</span><br><span class="line">        minimum-idle: 10</span><br><span class="line">  # 2. Configure Table/DB selection strategies</span><br><span class="line">  sharding:</span><br><span class="line">    tables:</span><br><span class="line">      web_order_:</span><br><span class="line">        actual-data-nodes: ds$-&gt;&#123;1..2&#125;.web_order_$-&gt;&#123;1..2&#125;</span><br><span class="line">        table-strategy:</span><br><span class="line">          inline:</span><br><span class="line">            sharding-column: id</span><br><span class="line">            algorithm-expression: web_order_$-&gt;&#123;id % 2 +1&#125;</span><br><span class="line">        database-strategy:</span><br><span class="line">          inline:</span><br><span class="line">            sharding-column: saleId</span><br><span class="line">            algorithm-expression: ds$-&gt;&#123;saleId % 2 +1&#125;</span><br><span class="line">      web_seckill:</span><br><span class="line">        actual-data-nodes: ds1.web_seckill</span><br><span class="line">  props:</span><br><span class="line">    sql:</span><br><span class="line">      show: true</span><br></pre></td></tr></table></figure>



<p>Shardingj 配置 –  分库分表  + Read Write Split：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8000</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  main:</span><br><span class="line">    allow-bean-definition-overriding: true</span><br><span class="line">  application:</span><br><span class="line">    name: orderGenerator</span><br><span class="line"># updated to ShardingSephere at 2022/1/11</span><br><span class="line">#  datasource:</span><br><span class="line">#    driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">#    url: jdbc:p6spy:mysql://192.168.100.128:3306/FlashSale</span><br><span class="line">#    username: root</span><br><span class="line">#    password: 1122110</span><br><span class="line">#    hikari:</span><br><span class="line">#      maximum-pool-size: 30</span><br><span class="line">#      minimum-idle: 10</span><br><span class="line">  shardingsphere:</span><br><span class="line">    # 1. Configure DataSource, same as normal datasource configuration</span><br><span class="line">    datasource:</span><br><span class="line">      # Allocate name to different databases</span><br><span class="line">      # Dont forgot to list any name here, other wise got error:</span><br><span class="line">      # java.lang.IllegalStateException: Missing the data source name: &#x27;ds1_slave&#x27;</span><br><span class="line">      #	at com.google.common.base.Preconditions.checkState(Preconditions.java:197)</span><br><span class="line">      names: ds1,ds1slave,ds2,ds2slave</span><br><span class="line">      # Configure each databases</span><br><span class="line">      ds1:</span><br><span class="line">        # configure type first -&gt; can use almost any connection pool</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">        # This has to be jdbc-url instead of url, otherwise the system cannot find the url address</span><br><span class="line">        jdbc-url: jdbc:p6spy:mysql://192.168.100.128:3306/FlashSale?serverTimezone=GMT%2B10</span><br><span class="line">        username: root</span><br><span class="line">        password: 1122110</span><br><span class="line">        hikari:</span><br><span class="line">          maximum-pool-size: 30</span><br><span class="line">          minimum-idle: 10</span><br><span class="line">      # slave for ds1</span><br><span class="line">      ds1slave:</span><br><span class="line">        # configure type first -&gt; can use almost any connection pool</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">        # This has to be jdbc-url instead of url, otherwise the system cannot find the url address</span><br><span class="line">        jdbc-url: jdbc:p6spy:mysql://127.0.0.1:3306/FlashSale?serverTimezone=GMT%2B10</span><br><span class="line">        username: root</span><br><span class="line">        password: 1122110</span><br><span class="line">        hikari:</span><br><span class="line">          maximum-pool-size: 30</span><br><span class="line">          minimum-idle: 10</span><br><span class="line">      ds2:</span><br><span class="line">        # configure type first -&gt; can use almost any connection pool</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">        jdbc-url: jdbc:p6spy:mysql://192.168.100.128:3306/FlashSale_2?serverTimezone=GMT%2B10</span><br><span class="line">        username: root</span><br><span class="line">        password: 1122110</span><br><span class="line">        hikari:</span><br><span class="line">          maximum-pool-size: 30</span><br><span class="line">          minimum-idle: 10</span><br><span class="line">      ds2slave:</span><br><span class="line">        # configure type first -&gt; can use almost any connection pool</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: com.p6spy.engine.spy.P6SpyDriver</span><br><span class="line">        jdbc-url: jdbc:p6spy:mysql://127.0.0.1:3306/FlashSale_2?serverTimezone=GMT%2B10</span><br><span class="line">        username: root</span><br><span class="line">        password: 1122110</span><br><span class="line">        hikari:</span><br><span class="line">          maximum-pool-size: 30</span><br><span class="line">          minimum-idle: 10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # Configure Table selection strategies</span><br><span class="line">    sharding:</span><br><span class="line">      defaultDataSourceName: ds1</span><br><span class="line">      tables:</span><br><span class="line">        web_order_:</span><br><span class="line">          actual-data-nodes: ms_ds$-&gt;&#123;1..2&#125;.web_order_$-&gt;&#123;1..2&#125;</span><br><span class="line">          table-strategy:</span><br><span class="line">            inline:</span><br><span class="line">              sharding-column: id</span><br><span class="line">              algorithm-expression: web_order_$-&gt;&#123;id % 2 +1&#125;</span><br><span class="line">          database-strategy:</span><br><span class="line">            inline:</span><br><span class="line">              sharding-column: saleId</span><br><span class="line">              algorithm-expression: ms_ds$-&gt;&#123;saleId % 2 +1&#125;</span><br><span class="line">        web_seckill:</span><br><span class="line">          actual-data-nodes: ms_ds1.web_seckill</span><br><span class="line">      master-slave-rules:</span><br><span class="line">        ms_ds1:</span><br><span class="line">          masterDataSourceName: ds1</span><br><span class="line">          slaveDataSourceNames:</span><br><span class="line">            - ds1slave</span><br><span class="line">        ms_ds2:</span><br><span class="line">          masterDataSourceName: ds2</span><br><span class="line">          slaveDataSourceNames:</span><br><span class="line">            - ds2slave</span><br><span class="line">    props:</span><br><span class="line">      sql:</span><br><span class="line">        show: true</span><br><span class="line">  devtools:</span><br><span class="line">    restart:</span><br><span class="line">      enabled: true</span><br><span class="line">      additional-paths: src/main/java</span><br><span class="line">  rabbitmq: # rabbitmq configuration</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 5672</span><br><span class="line">    virtual-host: /</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br><span class="line">    connection-timeout: 5000</span><br><span class="line">    listener:</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual</span><br><span class="line">        prefetch: 1</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br><span class="line">  type-aliases-package: com.java.pojo</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="Problems-Reflection："><a href="#Problems-Reflection：" class="headerlink" title="Problems Reflection："></a><strong>Problems Reflection：</strong></h3><ol>
<li><p>配置数据源时， 官网文档配置方式为 url: xxxxxx； 但项目中报错， 修改为 jdbc-url: xxx时 解决。  不确定原因， 可能与 sharding 版本及 连接池 选取有关。</p>
</li>
<li><p>sharding pom使用 4.0.0 RC 版本时， 报错 data tuncate error:  Now()…  。  NOW() 不可用。 已经确定是该版本bug， 更换 4.1.1 版本后解决</p>
</li>
<li><p>RabbitMQ 导致的：</p>
<ol>
<li><p>消息阻塞， 无法创建订单。</p>
<p>a. 逻辑错误导致返回ACK的代码未被执行</p>
<p>b. 忘了配置DB的选取策略， 导致更新web_seckill的 query始终返回0</p>
<p>两个错误导致ACK未被正确返回， 导致MQ中始终有unacked消息， 由于<strong>rabbitMQ的机制（待看）</strong>， 导致消息被阻塞。</p>
</li>
<li><p>发送一条request， 创建多条订单。</p>
<p>a. 不确定原因， 应该也与 rabbitMQ机制导致的 unack时重试机制产生， 1.a/1.b修复后没有再发生</p>
</li>
<li><p>与上两条错误相关：  再unack消息存在时， 每当重启module后有时可创建到消息， 但都是之前发送的积压订单。 新启动以后发送的请求未被创建到订单。 并且不管发送多少条都没有被创建， 但是再下次重启时， 又创建到了之前发送的请求。</p>
<p>应该也是unack的阻塞导致的， 也与 重试机制等有关。</p>
</li>
</ol>
</li>
<li><p>配置读写分离时报错：</p>
<p>java.lang.IllegalStateException: Missing the data source name: ‘ds1_slave’</p>
<p>at com.google.common.base.Preconditions.checkState(Preconditions.java:197)</p>
<p>原因：</p>
<p>datasources.names中忘了加两个slave的名字， 添加后解决。</p>
</li>
<li><p>修改 sharding column 时报错：</p>
<p>Cause: java.lang.NullPointerException: Cannot invoke method mod() on null object</p>
<p>原因： 修改了algorithm-expression: xxx 但是忘了修改对应的 sharding-column: xx</p>
</li>
<li><p>sharding-column的修改：</p>
<ol>
<li><p>原配置：</p>
<p>sharding-column分别为 order_No and saleId， 对应分表及分库策略</p>
<p>问题：</p>
<p>只考虑创建订单的话，用这两个column选用表和库没问题， 但是由于payment module中使用 userId + saleId 更新数据， column的使用不同， <strong>是否有可能retrieve不到数据？</strong>因为 写订单时， orderno 和 saleid决定了去4个表中的哪个表（2库， 每个库2个表）， 那么retrieve数据时， 用orderno+saleid检索，或者只用其中一个检索就没问题， 因为一定能route到数据所在的表,  但是 若用 userId+saleId的话， <strong>是否有可能根据 saleId 选定了库， 但是因为这个query中只有saleId, 没有orderno， 所以是否可能数据所在的表不在这个库中？  就算sharding能自动解决这个问题的话， 应该也需要检测两个库中的表1， 或一个库中的表1及表2， 应该会拖慢并发量。</strong> 因此改成根据saleId + userId选取库和表。</p>
</li>
<li><p>Alternative Solution:</p>
<p>Solution 1:</p>
<p>仍然用 orderno + saleid 做分库分表。然后再payment module中根据orderno  retrive row修改状态。 但是问题是这样payment接受的http参数就必须是orderno, 也就意味着orderno必须在用户秒杀成功后直接从deduct redis中返回。 然而问题在于目前 orderno在ordergenerate model中生成， 其从MQ接受消息， 与deduct redis异步执行， 所以没办法从ordergenerate model返回orderno 到deduct redis然后再从deduct redis返回给用户。 （该问题应该无解， 因为MQ异步）</p>
<p>要解决该问题， 就得让order no在deduct redis这个秒杀module中生成， 但是这样一来该module就在秒杀过程中干了别的事， 尽管生成订单号业务不复杂， 但是应该还是会拖慢并发量。</p>
<p>Solution 2:</p>
<p>只用一个column做sharding-column， 即库/表的选取都是对同一个column取模。 </p>
<p>不确定这样是否可行， 没试（理论上觉得可行）。 同时也不确定这样是否有任何缺点。</p>
</li>
</ol>
</li>
</ol>
<p>**RW Splitting Validation ** （测试于修改sharding column之前）</p>
<p><img src="E:\ShianGit\flash_sale\images\MySQL-Archetecture\MS_Write_Validation.PNG" alt="MS_Write_Validation"></p>
<p><img src="E:\ShianGit\flash_sale\images\MySQL-Archetecture\MS_Select_Validation.PNG" alt="MS_Select_Validation"></p>
<p>分库分表验证未截图， 但对于saleId=2时， 做orderNo的测试， 分表的选择没有问题。</p>
<p>由于redis中没添加 奇数的saleId， 所以未测分库的选取， 但应该没有问题。</p>
<h1 id="Redis-Master-slave-Sentinel-的报错（大坑）"><a href="#Redis-Master-slave-Sentinel-的报错（大坑）" class="headerlink" title="Redis Master/slave + Sentinel 的报错（大坑）"></a>Redis Master/slave + Sentinel 的报错（大坑）</h1><h3 id="配置sentinel时-redisson及redis读到的ip始终是Localhost，-而不是配置文件中设置的VM-IP。-进而导致："><a href="#配置sentinel时-redisson及redis读到的ip始终是Localhost，-而不是配置文件中设置的VM-IP。-进而导致：" class="headerlink" title="配置sentinel时,  redisson及redis读到的ip始终是Localhost， 而不是配置文件中设置的VM IP。 进而导致："></a>配置sentinel时,  redisson及redis读到的ip始终是Localhost， 而不是配置文件中设置的VM IP。 进而导致：</h3><h4 id="Errors"><a href="#Errors" class="headerlink" title="Errors:"></a>Errors:</h4><ul>
<li>Cannot connect to server  –&gt; 原因1. Sentinel问题</li>
<li>Sentinel Sentinels return empty sets  –&gt; 原因1</li>
<li>Cannot connect to 127.0.0.1：Master/Slave’s port–&gt; 原因2</li>
</ul>
<h4 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h4><ol>
<li><h5 id="Sentinel地址读取错误"><a href="#Sentinel地址读取错误" class="headerlink" title="Sentinel地址读取错误"></a>Sentinel地址读取错误</h5><p>原因：</p>
<p>Redisson 配置Sentinel模式时， 不可使用redisson-config.yml配置， 读取不到sentinel地址，所以应该自动设置成了localhost。 改成手动配置恢复正常。之所以会这样貌似是因为 redisson的config中， 要直接配置多个地址的话， 需要nodes.toArrayList… 之类的操作。而使用哨兵模式则无可避免需要配置多个地址， 故出错。</p>
<p>Error Reflection:</p>
<p>之所以有Sentinel Sentinels return … 这个报错， 因为springboot连接到redis sentinel以后， 会先执行这个命令。 该报错实际就是在 redis-cli中执行 sentinel sentinels +  mymaster（master配置的名字） 返回不到值。 之所以返回不到值，是因为sentinel地址没有读到， 连接到了localhost的默认端口， 所以根本没链接到sentinel。</p>
<p>关于为什么执行Sentinel sentinels:</p>
<p>可能性1： health check的目的， 即检测连接的目的。 应该是这个原因， google时候有看到差不多的。 而且该报错可以通过 setCheckList = False 消除。即不让它先查询。</p>
<p>可能性2： 也可能是因为 Sentinel地址错了以后， 读取不到配置中的Sentinel地址， 所以想通过该指令得到其他sentinel的地址？但是又因为每个sentinel的地址都不对， 所以得不到返回值。）</p>
</li>
<li><h5 id="Master-and-Slave地址读取错误"><a href="#Master-and-Slave地址读取错误" class="headerlink" title="Master and Slave地址读取错误"></a>Master and Slave地址读取错误</h5><p>由于在springboot中使用redis的sentinel + MS 模式时， Master and Slave的地址是springboot通过sentinel得到的。 即当sentinel连接成功后， 其会像 springboot返回 master and slave’s ip + port。</p>
<p>这意味着， springboot中添加的master and slave’s address， 其实是根据sentinel返回的值拼接得到的。 而sentinel返回给springboot的值， 其实就是在redis-cli中 sentinel masters /  sentinel slaves mymaster 显示的 IP值和 Port值。</p>
<p>而sentinel中的这两个值， 是根据sentinel.conf中的内容获取。 所以如果 sentinle中的 sentinel monitor mymaster IP Port Qurum 中的IP配置的是 127.0.0.1的话， 那么sentinel masters中的ip值就是 127.0.0.1， 所以返回给springboot的值也是localhost。 故连接不到。因此修改的第一步为把sentinel.conf中的localhost改成了VM IP。 修改后master的IP在springboot中正确得到。</p>
<p>但是Slave的IP依然错误。 并且关闭master，迫使Sentinel重新选主后，新的Master的 IP再次错误。 之所以这样， 是因为：</p>
<p>​    1） 在 sentinel.conf中， 我们只需要配置，也只能够配置 master的IP。 而slave的IP是sentinel通过master得来的（Sentinel 周期发送的那三个消息， 待复习）。 而master处的slaveIP 无法在master的conf中显示配置， 是自动得到的， 结果就是slave的IP被自动设置成了127.0.0.1。 进而slave在sentinel中存的IP就是127….， which means Springboot从sentinel得到的slaveIP依然是localhost。</p>
<p>​    2） sentinel会自动修改sentinel.conf中的sentinel monitor…的配置， 所以例如手动配置了  xxx realIP + port1， 再重新选主以后， sentinel也会重新用存储的原slave的IP跟port将该配置项修改为 xxx localhost + newMaster’s Port。 之所以这里IP变成了xxx， 源于above reason 1)。</p>
<p>解决办法：  配置 slave的conf中的announceIP为VM的真实IP。该项配置指明让server（无论是Master/Slave, 只要其conf中配置了就有效）暴露给外部的IP为设置的announce IP。  进而master得到的就是配置的IP-&gt; sentinel 得到 -&gt; springboot得到。</p>
<p>总结原因2处理：</p>
<ol>
<li>修改sentinel.conf中的sentinel monitor mymaster IP Port Qurum， 使IP为真实VM‘s IP</li>
<li>配置sentinel.conf中的announce ip</li>
<li>配置servers.conf中的announce ip, including master and slaves</li>
</ol>
</li>
</ol>
<p>​        </p>
<h1 id="压测记录"><a href="#压测记录" class="headerlink" title="压测记录"></a>压测记录</h1><h3 id="v1-2022-01-06"><a href="#v1-2022-01-06" class="headerlink" title="v1 - 2022/01/06"></a>v1 - 2022/01/06</h3><h4 id="Archetecture"><a href="#Archetecture" class="headerlink" title="Archetecture:"></a>Archetecture:</h4><p><strong>Modules and Archetecture:</strong> 单台 秒杀接口 （未开秒杀flash sale entry module 即consumer， 因此也无 loadbalance）+ 单order module + product scan model  + Message MQ;</p>
<p><strong>redis 中数据结构：</strong> HashTable-&gt; 4 kvs in the value  ==&gt; wait to be updated to store as a list (control as ziplist) and compare the performance</p>
<p><strong>分布式锁：</strong> redisson</p>
<h4 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h4><p>单台秒杀接口吞吐量始终 200多， 待测多台 吞吐量是否提升</p>
<ol>
<li>4000 并发量 -&gt; 连续测3组 0 Error rate + 0 超卖 </li>
</ol>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\压测2022-01-06\压测2022-01-06.PNG" alt="压测2022-01-06"></p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\压测2022-01-06\库存.PNG" alt="库存"></p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\压测2022-01-06\订单.PNG" alt="订单"></p>
<p>2)5000并发量 -&gt; 连续测3组 + 1组</p>
<p>第三组 0.7% Error。 无超卖</p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\2022-01-06-5000\1.PNG" alt="1"></p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\2022-01-06-5000\3.PNG" alt="3"></p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\2022-01-06-5000\2.PNG" alt="2"></p>
<p>第一， 二组 0 Error 无超卖，  隔2分钟第四组 0Error 0超卖</p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\2022-01-06-5000\v2-1.PNG" alt="v2-1"></p>
<p>3） 6000并发量 -&gt; 3组</p>
<p>第一组 0Error 无超卖（图片中总数忘了清空上次结果）</p>
<p><img src="E:\ShianGit\flash_sale\images\压测\压测\2020-01-06-6000\1.PNG" alt="1"></p>
<p>第二组0.3Error 无超卖</p>
<ol start="4">
<li>7000 1.99 Error 无超卖</li>
</ol>
<p>5） 10000 -&gt; 无超杀 9% Error</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2021/12/22/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/12/22/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-1/" itemprop="url">
                  分布式锁(1) redisson
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-12-22T10:37:22+11:00">
                2021-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="从伪超杀问题的解决思路及问题演变理解Redisson加锁机制"><a href="#从伪超杀问题的解决思路及问题演变理解Redisson加锁机制" class="headerlink" title="从伪超杀问题的解决思路及问题演变理解Redisson加锁机制"></a>从伪超杀问题的解决思路及问题演变理解Redisson加锁机制</h1><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ul>
<li><p>功能： 秒杀 –&gt; 高并发</p>
</li>
<li><p>架构： nginx + multiple TomCat + Redis Database (Redis中存一简单KV， K = 商品名， V = 库存)</p>
</li>
<li><p>Note： 均为伪场景， 实际秒杀问题并非这样设计</p>
</li>
</ul>
<h3 id="V1"><a href="#V1" class="headerlink" title="V1"></a>V1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> string <span class="title">deductStock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> stock = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">&quot;stock&quot;</span>));  <span class="comment">// 得到stock数量</span></span><br><span class="line">    <span class="keyword">if</span> ( strock &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> realStrock = stock - <span class="number">1</span>;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;stock&quot;</span>, realStrok + <span class="string">&quot;&quot;</span>);  <span class="comment">// 写回</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        库存不足；</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>问题</strong>：</p>
<p>单机内，TomCat集群皆无锁。</p>
<p>线程1 得到stock = 200 时， 线程2 也可能得到stock = 200， 两个线程操作后正常数量应为198， 但是均写回了199。</p>
<h3 id="V2"><a href="#V2" class="headerlink" title="V2"></a>V2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> string <span class="title">deductStock</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> stock = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">&quot;stock&quot;</span>));  <span class="comment">// 得到stock数量</span></span><br><span class="line">        <span class="keyword">if</span> ( strock &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> realStrock = stock - <span class="number">1</span>;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(<span class="string">&quot;stock&quot;</span>, realStrok + <span class="string">&quot;&quot;</span>);  <span class="comment">// 写回</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            库存不足；</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>evolution1: added Synchronized keyword</p>
</li>
<li><p>问题：</p>
<p>单机内实现了并发安全， 但集群下无效，因为多个TomCat同一时刻下均各自出来一条线程访问redis， 此时依然有线程安全问题</p>
</li>
</ul>
<h3 id="V3"><a href="#V3" class="headerlink" title="V3"></a>V3</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> string <span class="title">deductStock</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">    String lockKey = <span class="string">&quot;lockKey&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 此处不可将设置key与设置超时两个步骤写成两句代码， 因为无法保证原子性， 如设置了key以后宕机了， 那么时间设置就丢失了。</span></span><br><span class="line">    Boolean result = StringRedisTemplate.opsForValue().setIfAbscent(lockKey, <span class="string">&quot;test&quot;</span>, <span class="number">10</span>, TimeUnit.Seconds);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (! result)</span><br><span class="line">		retrun <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        nt stock = Integer.parseInt(stringRedisTemplate.opsForValue().get(<span class="string">&quot;stock&quot;</span>));  <span class="comment">// 得到stock数量</span></span><br><span class="line">        <span class="keyword">if</span> ( strock &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> realStrock = stock - <span class="number">1</span>;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;stock&quot;</span>, realStrok + <span class="string">&quot;&quot;</span>);  <span class="comment">// 写回</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">    库存不足；</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span>&#123;</span><br><span class="line">        stringRedisTemplate.delete(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    i</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>evolution2:</p>
<ul>
<li>利用 redis的单线成特性， <strong>使用setnx指令</strong>， 使各个线程串行的取set一个key， 如果set成功则代表抢锁成功， <strong>此时没抢到锁的线程做自旋等待。</strong></li>
<li>同时需将key设置expire时间， 其目的是防止程序跑到finally前宕机而无法释放这个key， 也即无法释放锁导致死锁。</li>
</ul>
</li>
<li><p>问题：</p>
<ul>
<li>线程实际运行时间超过设置的expire时间， 一个线程还未结束时就释放了锁， 此时线程2拿到锁， 线程2运行过程中线程1运行结束调用finally代码， 从而删除了这个key，也即释放了这个锁。 但问题是此时这个被删除的锁其实是线程2的。 –&gt; 这个现象称为永久失效？</li>
</ul>
</li>
</ul>
<h3 id="V4"><a href="#V4" class="headerlink" title="V4"></a>V4</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> string <span class="title">deductStock</span><span class="params">()</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">    String lockKey = <span class="string">&quot;lockKey&quot;</span>;</span><br><span class="line">    String clientID = <span class="string">&quot;..&quot;</span></span><br><span class="line">    <span class="comment">// 此处不可将设置key与设置超时两个步骤写成两句代码， 因为无法保证原子性， 如设置了key以后宕机了， 那么时间设置就丢失了。</span></span><br><span class="line">    Boolean result = StringRedisTemplate.opsForValue().setIfAbscent(lockKey, clientID, <span class="number">10</span>, TimeUnit.Seconds);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (! result)</span><br><span class="line">		retrun <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line"> 		# 更新内存并写回</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( clientID.equals(redis.get(LockKey)))</span><br><span class="line">        &#123;</span><br><span class="line">            stringRedisTemplate.delete(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    i</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Evolution:<ul>
<li>V3的问题是一个线程删除了不属于自己的锁， 也即不属于自己的key， 所以V4将key的value设置成线程唯一的， 再删除key之前先判断这个key是不是自己的</li>
</ul>
</li>
<li>问题：<ul>
<li>依然会出现一个线程删除了不属于自己的key的情况。 如： key的超时时间为10s, 即10s后一个key会被自动删除。 假设在第9.99999s时， 一个线程运行了finally 中的if条件， 判断if为true， 所以开始执行delete操作。 而在执行delete时， 已经是第10.000001s。 这意味着该线程的key其实已经被自动删除了， 而此时再此执行delete， 则删除的还是另一个线程的锁，即key。</li>
</ul>
</li>
<li>该问题原因：<ul>
<li>所有线程都用了同一个名称的key，即锁。 –&gt;  无法解决<ul>
<li>因为，利用redis实现分布式线程安全的本质是利用了“SETNX”， 这意味着所有线程必须使用同一个名称的KEY。</li>
</ul>
</li>
<li>一个线程还未正常运行结束时， key就超时被自动删除了 –&gt; 可解决： <strong>线程运行中为其持有的key续时间</strong>， which is Redisson did。</li>
</ul>
</li>
</ul>
<h3 id="Redisson-Lock"><a href="#Redisson-Lock" class="headerlink" title="Redisson Lock"></a>Redisson Lock</h3><p>Redisson Lock即帮助自动的为一个线程持有的锁“续命”， 从而避免出现误删其他线程的key的问题。</p>
<p>总结 Redisson Lock工作原理本质：</p>
<ul>
<li>利用SETNX的特点（实际源码中并不是这么写， 但原理是一样的）， 即判断一个key是否存在， 存在即不可持有， 不存在则可更新value， 来实现给线程分发锁。</li>
<li>使每个线程持有的key中的value唯一， 来实现防止误删的问题。</li>
<li>使每个线程持有的key自动续命， 来实现防止误删的问题。</li>
<li>Redisson Lock的源码中大量使用Lua脚本语言来保证操作的原子性。</li>
</ul>
<h3 id="Extra-如何提高并发效率？"><a href="#Extra-如何提高并发效率？" class="headerlink" title="Extra: 如何提高并发效率？"></a>Extra: 如何提高并发效率？</h3><p>上述场景中， 所有操作时串行的，例如stock=1000， 那么每个线程都需排队操作者1000个库存。 效率低下。 </p>
<p>若想提高并发效率， 可将stock分段， 如分成stock_001 = 200,  stock_002 = 200 …. ， 如此并发效率便提高五倍。 同时服务器压力也会增大。 即分段粒度越高， 并发效率越高。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2021/12/09/%E9%9D%A2%E8%AF%95%E5%85%AB%E8%82%A1%E6%96%87-Spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/12/09/%E9%9D%A2%E8%AF%95%E5%85%AB%E8%82%A1%E6%96%87-Spring/" itemprop="url">
                  面试八股文-Spring
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-12-09T08:07:01+11:00">
                2021-12-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://shain001.github.io/2021/12/06/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shain's Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/12/06/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E6%A0%91/" itemprop="url">
                  算法随手-树
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-12-06T15:28:56+11:00">
                2021-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithm</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Algorithm/Data-Structure/" itemprop="url" rel="index">
                    <span itemprop="name">Data Structure</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>与树结构相关的题，多为递归求解。 若可确定使用递归求解树相关的题， 则：</p>
<ul>
<li>分析问题， 确定解体步骤。</li>
<li>按照步骤，确定递归函数。 所谓确定递归函数，即以下三个步骤：<ul>
<li>确定函数终止条件<ul>
<li><strong>在利用递归解决树相关问题时， 为了确定函数终止条件， 可以从输入的节点的不同状态入手，进而判断何时应该是False, 也即被拦截，或者说被终止。</strong>例如， a, b两个节点都为空则如何， 一个为空如何等等。 同时，如果有可以合并的终止条件， 那么在写if 条件时， 可以利用不同 if 间的顺序达到精简代码的效果。</li>
<li><strong>并且目前接触到的大部分情况下。 再树中递归时的终止条件基本是拦截所有False的情况， 对于True的情况不需显示写if拦截， 只需让程序继续往下跑即可。 那么通常此时是跑到 return的函数方程， 或者进行某些更改操作。</strong></li>
</ul>
</li>
<li>确定函数功能</li>
<li>确定递归方程</li>
<li>切记不要用人脑模拟递归过程！</li>
</ul>
</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2021/12/06/%E7%AE%97%E6%B3%95%E9%9A%8F%E6%89%8B-%E6%A0%91/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="" />
          <p class="site-author-name" itemprop="name"></p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shain</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
